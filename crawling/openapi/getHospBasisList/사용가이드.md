# 병원정보 조회 API 사용 가이드

건강보험심사평가원(HIRA) 병원정보서비스 API를 사용하여 전국 병원 정보를 조회하는 Python 스크립트 사용 가이드입니다.

---

## 📋 목차

1. [시작하기](#시작하기)
2. [API 키 설정](#api-키-설정)
3. [기본 사용법](#기본-사용법)
4. [고급 기능](#고급-기능)
5. [검색 조건 설정](#검색-조건-설정)
6. [문제 해결](#문제-해결)
7. [코드 예시](#코드-예시)

---

## 시작하기

### 필수 라이브러리 설치

```bash
pip install requests pandas openpyxl
```

### 파일 구성

```
getHospBasisList/
├── 병원정보_조회.py          # 메인 스크립트
├── 사용가이드.md             # 이 파일
└── 서울_강남구_피부과_*.xlsx  # 출력 파일 (실행 후 생성)
```

---

## API 키 설정

### 1. API 키 발급

1. [공공데이터포털](https://www.data.go.kr) 접속
2. 회원가입 및 로그인
3. **"병원정보서비스"** 검색
4. 활용신청 (승인까지 약 1-2시간 소요)
5. 마이페이지 → 인증키 발급현황에서 키 확인

### 2. 스크립트에 API 키 설정

`병원정보_조회.py` 파일을 열어 다음 부분을 수정합니다:

```python
# 인증키 설정
SERVICE_KEY = "여기에_발급받은_API_키를_입력"

# API 키 타입 설정
USE_ENCODED_KEY = True  # 인코딩 키 사용 시 True, 디코딩 키 사용 시 False
```

> [!IMPORTANT]
> **인코딩 키 vs 디코딩 키**
> - **인코딩 키**: 공공데이터포털에서 복사한 키에 `%2F`, `%3D` 등의 문자가 포함된 경우
>   - 예: `Bk8Li...%2Fmmgt...%3D%3D`
>   - `USE_ENCODED_KEY = True` 설정
> - **디코딩 키**: 특수문자가 그대로 있는 경우
>   - 예: `Bk8Li.../mmgt...==`
>   - `USE_ENCODED_KEY = False` 설정

---

## 기본 사용법

### 1. 스크립트 실행

```bash
python 병원정보_조회.py
```

### 2. 기본 동작

스크립트는 기본적으로 **서울 강남구 피부과** 정보를 조회합니다:

```python
sido_cd = SIDO_CODES['서울']              # 시도: 서울
sggu_cd = SEOUL_SGGU_CODES['강남구']      # 시군구: 강남구
dgsbj_cd = DGSBJ_CODES['피부과']          # 진료과목: 피부과
```

### 3. 출력 결과

- **콘솔 출력**: 처음 10개 병원 정보 표시
- **엑셀 파일**: `서울_강남구_피부과_YYYYMMDD_HHMMSS.xlsx` 생성

---

## 고급 기능

### 1. 재시도 로직 (자동)

네트워크 오류 발생 시 자동으로 최대 3회까지 재시도합니다.

```python
# 재시도 설정 (스크립트 상단에서 변경 가능)
MAX_RETRIES = 3          # 최대 재시도 횟수
RETRY_DELAY = 1          # 초기 대기 시간 (초)
```

**재시도 간격**: 1초 → 2초 → 4초 (지수 백오프)

### 2. 체크포인트 (진행상황 저장)

대량 데이터 수집 중 중단되어도 이어서 진행할 수 있습니다.

```python
# 체크포인트 설정
ENABLE_CHECKPOINT = True # 진행상황 저장 활성화
CHECKPOINT_INTERVAL = 5  # 5페이지마다 저장
```

**동작 방식**:
- 5페이지마다 `checkpoint_YYYYMMDD_HHMMSS.json` 파일 생성
- 중단 후 재실행 시 자동으로 이전 진행 지점부터 재개
- 완료 후 체크포인트 파일 자동 삭제

### 3. 타임아웃 설정

```python
CONNECT_TIMEOUT = 10     # 연결 타임아웃 (초)
READ_TIMEOUT = 60        # 읽기 타임아웃 (초)
```

---

## 검색 조건 설정

### 1. 지역별 검색

#### 시도 코드

```python
SIDO_CODES = {
    '서울': '110000',
    '부산': '260000',
    '대구': '270000',
    '인천': '280000',
    '광주': '290000',
    '대전': '300000',
    '울산': '310000',
    '세종': '360000',
    '경기': '410000',
    '강원': '430000',
    '충북': '440000',
    '충남': '450000',
    '전북': '460000',
    '전남': '470000',
    '경북': '480000',
    '경남': '490000',
    '제주': '500000'
}
```

#### 서울 시군구 코드

```python
SEOUL_SGGU_CODES = {
    '강남구': '110001',
    '강동구': '110002',
    '강북구': '110003',
    '강서구': '110004',
    '관악구': '110005',
    '광진구': '110006',
    '구로구': '110007',
    '금천구': '110008',
    '노원구': '110009',
    '도봉구': '110010',
    '동대문구': '110011',
    '동작구': '110012',
    '마포구': '110013',
    '서대문구': '110014',
    '서초구': '110015',
    '성동구': '110016',
    '성북구': '110017',
    '송파구': '110018',
    '양천구': '110019',
    '영등포구': '110020',
    '용산구': '110021',
    '은평구': '110022',
    '종로구': '110023',
    '중구': '110024',
    '중랑구': '110025'
}
```

### 2. 진료과목별 검색

```python
DGSBJ_CODES = {
    '일반의': '00',
    '내과': '01',
    '신경과': '02',
    '정신건강의학과': '03',
    '외과': '04',
    '정형외과': '05',
    '신경외과': '06',
    '흉부외과': '07',
    '성형외과': '08',
    '마취통증의학과': '09',
    '산부인과': '10',
    '소아청소년과': '11',
    '안과': '12',
    '이비인후과': '13',
    '피부과': '14',
    '비뇨의학과': '15',
    '가정의학과': '23',
    '응급의학과': '24'
}
```

### 3. 종별 코드

```python
CL_CODES = {
    '상급종합병원': '01',
    '종합병원': '11',
    '병원': '21',
    '요양병원': '28',
    '정신병원': '29',
    '의원': '31',
    '치과병원': '41',
    '치과의원': '51',
    '조산원': '61',
    '보건소': '71',
    '보건지소': '72',
    '보건진료소': '73',
    '보건의료원': '75',
    '한방병원': '92',
    '한의원': '93'
}
```

---

## 문제 해결

### 1. 인증 오류 (401 Unauthorized)

**원인**:
- API 키가 잘못되었거나
- API 키 타입 설정이 잘못됨

**해결 방법**:
```python
# 1. API 키 확인
SERVICE_KEY = "정확한_API_키"

# 2. 키 타입 확인
# 인코딩 키 (%2F, %3D 포함) → USE_ENCODED_KEY = True
# 디코딩 키 (/, = 포함) → USE_ENCODED_KEY = False
USE_ENCODED_KEY = True  # 또는 False
```

### 2. 500 Server Error

**원인**:
- 이중 인코딩 문제
- API 서버 일시적 오류

**해결 방법**:
```python
# 키 타입을 반대로 변경해보기
USE_ENCODED_KEY = False  # True였다면 False로 변경
```

### 3. 타임아웃 오류

**원인**:
- 네트워크 속도 느림
- API 서버 응답 지연

**해결 방법**:
```python
# 타임아웃 시간 증가
CONNECT_TIMEOUT = 20     # 10 → 20초
READ_TIMEOUT = 120       # 60 → 120초
```

### 4. 중단 후 재개

**상황**: 실행 중 중단됨

**해결 방법**:
1. 그냥 다시 실행: `python 병원정보_조회.py`
2. 체크포인트 파일이 있으면 자동으로 이어서 진행됨
3. 처음부터 다시 시작하려면 `checkpoint_*.json` 파일 삭제

---

## 코드 예시

### 예시 1: 서울 서초구 성형외과 검색

```python
def main():
    sido_cd = SIDO_CODES['서울']
    sggu_cd = SEOUL_SGGU_CODES['서초구']
    dgsbj_cd = DGSBJ_CODES['성형외과']
    
    hospitals = get_all_hospitals(
        service_key=SERVICE_KEY,
        use_encoded_key=USE_ENCODED_KEY,
        sido_cd=sido_cd,
        sggu_cd=sggu_cd,
        dgsbj_cd=dgsbj_cd
    )
    
    # 결과 출력 및 저장
    print_hospital_info(hospitals, max_display=10)
    
    if hospitals:
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"서울_서초구_성형외과_{timestamp}.xlsx"
        save_to_excel(hospitals, filename)
```

### 예시 2: 병원명으로 검색

```python
def search_by_name():
    hospitals = get_all_hospitals(
        service_key=SERVICE_KEY,
        use_encoded_key=USE_ENCODED_KEY,
        yadm_nm="서울대학교병원"  # 병원명에 포함된 키워드
    )
    
    print_hospital_info(hospitals)
    
    if hospitals:
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"병원명_검색_{timestamp}.xlsx"
        save_to_excel(hospitals, filename)
```

### 예시 3: 특정 지역 종합병원 검색

```python
def search_general_hospitals():
    hospitals = get_all_hospitals(
        service_key=SERVICE_KEY,
        use_encoded_key=USE_ENCODED_KEY,
        sido_cd=SIDO_CODES['서울'],
        sggu_cd=SEOUL_SGGU_CODES['강남구'],
        cl_cd=CL_CODES['종합병원']
    )
    
    print_hospital_info(hospitals)
    
    if hospitals:
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"서울_강남구_종합병원_{timestamp}.xlsx"
        save_to_excel(hospitals, filename)
```

### 예시 4: 서울 전체 소아청소년과 검색

```python
def search_pediatrics_seoul():
    hospitals = get_all_hospitals(
        service_key=SERVICE_KEY,
        use_encoded_key=USE_ENCODED_KEY,
        sido_cd=SIDO_CODES['서울'],
        dgsbj_cd=DGSBJ_CODES['소아청소년과']
    )
    
    print_hospital_info(hospitals)
    
    if hospitals:
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"서울_전체_소아청소년과_{timestamp}.xlsx"
        save_to_excel(hospitals, filename)
```

### 예시 5: 체크포인트 비활성화

```python
def search_without_checkpoint():
    hospitals = get_all_hospitals(
        service_key=SERVICE_KEY,
        use_encoded_key=USE_ENCODED_KEY,
        sido_cd=SIDO_CODES['서울'],
        sggu_cd=SEOUL_SGGU_CODES['강남구'],
        dgsbj_cd=DGSBJ_CODES['피부과'],
        enable_checkpoint=False  # 체크포인트 비활성화
    )
    
    # ... 결과 처리
```

---

## 출력 데이터 컬럼

엑셀 파일에 저장되는 주요 컬럼:

| 컬럼명 | 설명 | 예시 |
|--------|------|------|
| 병원명 | 의료기관 명칭 | 서울대학교병원 |
| 종별 | 의료기관 종별 | 상급종합병원 |
| 시도 | 시도명 | 서울 |
| 시군구 | 시군구명 | 종로구 |
| 읍면동 | 읍면동명 | 연건동 |
| 주소 | 도로명 주소 | 서울특별시 종로구 대학로 101 |
| 우편번호 | 우편번호 | 03080 |
| 전화번호 | 대표 전화번호 | 02-2072-2114 |
| 홈페이지 | 홈페이지 URL | http://www.snuh.org |
| 개설일자 | 개설일자 | 19780101 |
| 의사총수 | 총 의사 수 | 1500 |
| 의과전문의 | 의과 전문의 수 | 1200 |
| 치과전문의 | 치과 전문의 수 | 50 |
| 한방전문의 | 한방 전문의 수 | 0 |
| 경도 | GPS 경도 | 127.0016985 |
| 위도 | GPS 위도 | 37.5800142 |

---

## 진행 상황 표시

스크립트 실행 중 다음과 같은 정보가 표시됩니다:

```
[API 호출] 페이지: 1, 결과 수: 100
[진행] 전체 1154건 중 0건 (0.0%)
[API 호출] 페이지: 2, 결과 수: 100
[진행] 전체 1154건 중 100건 (8.7%), 예상 남은 시간: 45초
[체크포인트 저장] checkpoint_20260113_204220.json
...
[완료] 총 1154건 조회 완료
[체크포인트 삭제] checkpoint_20260113_204220.json
[저장 완료] 서울_강남구_피부과_20260113_204220.xlsx (1154건)
```

---

## 주의사항

> [!WARNING]
> **API 호출 제한**
> - 공공데이터포털 API는 일일 호출 횟수 제한이 있을 수 있습니다
> - 대량 데이터 수집 시 시간이 오래 걸릴 수 있습니다
> - 체크포인트 기능을 활성화하여 안전하게 수집하세요

> [!TIP]
> **성능 최적화**
> - 검색 조건을 구체적으로 설정하면 더 빠릅니다
> - 전국 단위 검색은 시간이 오래 걸립니다
> - 지역별로 나누어 검색하는 것을 권장합니다

---

## 라이선스 및 참고

- **데이터 출처**: 건강보험심사평가원 병원정보서비스
- **API 제공**: 공공데이터포털 (data.go.kr)
- **작성일**: 2026-01-13
- **Python 버전**: 3.7 이상 권장

---

## 문의 및 지원

API 관련 문의:
- 공공데이터포털 고객센터: 1661-0211
- 이메일: [email protected]

스크립트 관련 문의:
- GitHub Issues 또는 프로젝트 관리자에게 문의
