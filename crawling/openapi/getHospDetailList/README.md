# 의료기관 전체정보 조회 스크립트 v2.00

건강보험심사평가원의 **의료기관별상세정보서비스 API**를 활용하여 병원의 **11개 모든 정보 카테고리**를 통합 조회하는 Python 스크립트입니다.

## 📋 개요

이 스크립트는 병원기본목록 CSV 파일에서 암호화된 요양기호를 읽어와 **11개 API를 순차 호출**하여 병원의 전체 상세정보를 조회하고 CSV 파일로 저장합니다.

### 주요 기능
- ✅ **11개 API 통합 조회**: 시설정보, 세부정보, 진료과목, 교통, 의료장비, 식대가산, 간호등급, 특수진료, 전문병원지정분야, 전문과목별전문의수, 기타인력수
- ✅ CSV 파일 입출력 (UTF-8 BOM 인코딩, Excel 호환)
- ✅ 자동 메타데이터 생성 (마크다운 분석 보고서)
- ✅ 재시도 로직 (지수 백오프)
- ✅ 체크포인트 기능 (중단 후 재개 가능)
- ✅ 진행률 표시 (예상 남은 시간 포함)
- ✅ 테스트 모드 (소량 데이터 테스트)
- ✅ 상세한 에러 처리

## 🚀 빠른 시작

### 1. 요구사항
- Python 3.8 이상
- 필수 라이브러리:
  ```bash
  pip install requests pandas openpyxl
  ```

### 2. API 인증키 발급
1. [공공데이터포털](https://www.data.go.kr) 접속
2. "의료기관별상세정보서비스" 검색
3. 활용신청 버튼 클릭
4. 승인 후 **디코딩 인증키** 복사

### 3. 스크립트 설정
`의료기관전체정보_조회_v2.00_260115.py` 파일을 열고 다음 항목을 수정:

```python
# 인증키 설정
SERVICE_KEY = "여기에_발급받은_디코딩_인증키_입력"

# 입력 파일 경로 (CSV 파일)
INPUT_CSV_FILE = r"D:\git_gb4pro\crawling\openapi\getHospDetailList\data\서울_강남구_피부과_20260115_212757.csv"

# 요양기호 컬럼명 (자동 탐지되므로 일반적으로 수정 불필요)
YKIHO_COLUMN = None  # 자동 탐지: 'ykiho', '암호화요양기호', '요양기호' 등

# 테스트 모드 (선택사항)
TEST_MODE = False  # True로 설정하면 3건만 처리
```

### 4. 실행
```bash
python 의료기관전체정보_조회_v2.00_260115.py
```

**소량 테스트 실행** (권장):
```python
# 스크립트에서 TEST_MODE = True로 설정 후 실행
python 의료기관전체정보_조회_v2.00_260115.py
```

## 📂 입력 파일 형식

병원기본목록 CSV 파일에 다음 컬럼이 포함되어야 합니다:
- **필수**: 암호화된 요양기호 컬럼 (`ykiho`, `암호화요양기호`, `요양기호` 등)
- **권장**: 병원명 (`yadmNm` 또는 `병원명`), 주소 (`addr` 또는 `주소`) - 원본 데이터 매핑용
- **인코딩**: UTF-8 BOM 또는 CP949 (자동 탐지)

## 📤 출력 파일

### 저장 위치
- **CSV 파일**: `data/병원전체정보_YYYYMMDD_HHMMSS.csv`
- **메타데이터**: `data/병원전체정보_YYYYMMDD_HHMMSS.md` (자동 생성)

### 출력 컬럼 구조
- **원본 데이터**: `원본_기관코드`, `원본_병원명`, `원본_주소`
- **11개 API 통합 데이터**: 각 API별로 접두사가 붙은 컬럼
  - `eqp_*`: 시설정보 (병상 수 등)
  - `dtl_*`: 세부정보 (병원명, 주소, 전화번호 등)
  - `dgsbjt_*`: 진료과목정보
  - `trnsprt_*`: 교통정보
  - `medoft_*`: 의료장비정보
  - `foepaddc_*`: 식대가산정보
  - `nursiggrd_*`: 간호등급정보
  - `spcldiag_*`: 특수진료정보
  - `spclhosp_*`: 전문병원지정분야
  - `spcsbtj_*`: 전문과목별전문의수
  - `etchst_*`: 기타인력수정보
- **인코딩**: UTF-8 BOM (Excel 호환)

### 메타데이터 파일 내용
자동 생성되는 마크다운 파일에는 다음 정보가 포함됩니다:
- 데이터 개요 (총 레코드 수, 컬럼 수)
- API별 수집 정보 통계
- 주요 컬럼 결측치 분석

## 🔧 고급 설정

### 재시도 설정
```python
MAX_RETRIES = 3          # 최대 재시도 횟수
RETRY_DELAY = 1          # 초기 재시도 대기 시간 (초)
```

### 타임아웃 설정
```python
CONNECT_TIMEOUT = 10     # 연결 타임아웃 (초)
READ_TIMEOUT = 60        # 읽기 타임아웃 (초)
```

### 체크포인트 설정
```python
ENABLE_CHECKPOINT = True # 진행상황 저장 활성화
CHECKPOINT_INTERVAL = 5  # 체크포인트 저장 간격 (건수)
```

## 💡 사용 팁

### 체크포인트 기능 활용
스크립트 실행 중 중단되더라도 다시 실행하면 이어서 진행됩니다:
```bash
# 실행 중 Ctrl+C로 중단
python 의료기관상세정보_조회_v1.00_260115.py

# 다시 실행하면 자동으로 이어서 진행
python 의료기관상세정보_조회_v1.00_260115.py
```

### 소량 데이터 테스트
전체 실행 전 소량 데이터로 테스트:
```python
# 스크립트 상단 설정 섹션에서
TEST_MODE = True  # 테스트 모드 활성화
MAX_TEST_RECORDS = 3  # 테스트할 레코드 수
```

## 🐛 문제 해결

### 인증키 오류
```
API 오류 [30]: SERVICE_KEY_IS_NOT_REGISTERED_ERROR
```
**해결**: 디코딩 인증키를 사용하고 있는지 확인

### 요양기호 컬럼 오류
```
컬럼 'ykiho'을(를) 찾을 수 없습니다.
```
**해결**: Excel 파일을 열어 요양기호 컬럼명 확인 후 `YKIHO_COLUMN` 수정

### 트래픽 제한 초과
```
API 오류 [22]: LIMITED_NUMBER_OF_SERVICE_REQUESTS_EXCEEDS_ERROR
```
**해결**: 개발 계정은 일 1,000건 제한. 다음 날 재시도 또는 운영 계정 신청

### API 엔드포인트 오류
```
HTTP 오류: 404
```
**해결**: 공공데이터포털에서 정확한 operation 이름 확인 후 `API_BASE_URL` 수정

## ✅ 성공 조건

스크립트가 성공적으로 실행되었는지 확인하는 방법:

### 1. 실행 로그 확인
```
[CSV 읽기] ...
  - 인코딩: utf-8-sig (성공)
  - 총 XXX건
  - 요양기호 컬럼 자동 탐지: ykiho
[진행] X/XXX건 (X.X%)
  [O] 조회 성공
[완료] 총 처리: XXX건 / 성공: XXX건
[저장 완료] data/병원상세정보_YYYYMMDD_HHMMSS.csv (XXX건)
[메타데이터 생성] data/병원상세정보_YYYYMMDD_HHMMSS.md
```

### 2. 출력 파일 검증
- [ ] `data/` 폴더에 CSV 파일 생성됨
- [ ] `data/` 폴더에 메타데이터 마크다운 파일 생성됨
- [ ] CSV 파일에 `원본_기관코드`, `원본_병원명`, `원본_주소` 컬럼 존재
- [ ] 원본 데이터가 비어있지 않음 (입력 파일의 병원명/주소와 일치)

### 3. 데이터 품질 확인
CSV 파일을 열어 다음을 확인:
```python
import pandas as pd
df = pd.read_csv('data/병원상세정보_YYYYMMDD_HHMMSS.csv', encoding='utf-8-sig')
print(df[['원본_병원명', 'yadmNm', '원본_주소', 'addr']].head())
```
- 원본 병원명과 API 응답 병원명이 일치하는지 확인
- 원본 주소와 API 응답 주소가 일치하는지 확인

## 📚 문서

- [API 가이드라인](getHospDetailList_api_guideline.md) - API 사용법 상세 설명
- [스크립트 작성 가이드라인](OpenAPI_스크립트_작성_가이드라인.md) - 범용 개발 가이드
- [개발 과정 문서](REPORT/개발과정_상세문서_20260115_184300.md) - 개발 과정 및 의사결정

## 🔍 관련 프로젝트

- [병원기본목록 조회 스크립트](../getHospBasisList/병원정보_조회_v1.00F_260113.py)
- [병원정보조회 웹앱](../getHospBasisList/병원정보조회_웹앱_V1.00.html)

## 📝 라이선스

이 스크립트는 공공데이터포털의 OpenAPI를 활용합니다. 데이터 사용 시 출처를 표시해야 합니다.

**데이터 출처**: 건강보험심사평가원_의료기관별상세정보서비스

## 👥 기여

버그 리포트나 개선 제안은 이슈로 등록해 주세요.

---

**버전**: 2.00  
**최종 수정**: 2026-01-16  
**작성자**: OpenAPI 스크립트 개발팀  
**주요 변경사항**: 11개 API 통합 조회, CSV 입출력, 자동 메타데이터 생성
