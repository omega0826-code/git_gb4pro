# 카카오 지오코딩 테스트 결과 및 수정 방안 리포트

**실행 일시**: 2026년 01월 25일 16:00  
**실행 스크립트**: `gis/geocoding/hospital/run_hospital_geocoding.py`  
**대상 파일**: `병원전체정보_20260116_212603_geocoded_20260125_155112.csv` (input 폴더로 이동 후 실행)

---

## 1. 테스트 결과: **실패 (Failure)**

스크립트 실행은 정상적으로 시작되었으나, 카카오 API 호출 시 모든 요청에 대해 **403 Forbidden** 에러가 발생하여 지오코딩에 실패했습니다.

### 1.1 상세 에러 로그 분석
- **데이터 로드**: 총 1,153건의 데이터가 정상적으로 로드됨.
- **주소 전처리**: 전처리 로직은 정상 작동한 것으로 보임.
- **API 호출 에러**:
    ```text
    ERROR - Error converting '...': 403 Client Error: Forbidden for url: https://dapi.kakao.com/v2/local/search/address.json?query=...
    ```
    - 모든 시도(0번~1,153번)에서 동일한 403 에러 발생.
    - URL 파라미터(query)의 한글 인코딩(`%EC%84%9C%EC%9A%B8...`)은 정상적으로 생성됨.
- **로그 인코딩 이슈**:
    - Windows 콘솔 출력 시 한글 주소가 깨져서 출력됨 (예: `Ư  Ͽ 81`). 이는 기능상의 오류는 아니나 디버깅을 어렵게 함.

### 1.2 403 Forbidden 원인 추정
Kakao API의 403 에러는 주로 다음 이유로 발생합니다:
1.  **API Key 유효성 문제**: `.env`에 설정된 키가 만료되었거나 오타가 있을 수 있음.
2.  **서비스 권한 없음**: 해당 API Key에 '로컬(Local) API' 사용 권한이 활성화되지 않음 (Kakao Developers 내 설정 확인 필요).
3.  **쿼터 초과 (Quota Exceeded)**: 일일 허용량(기본 300,000건)을 초과함.
4.  **IP 제한**: 해당 키에 특정 IP 접근 제한이 걸려있고, 현재 실행 환경 IP가 허용되지 않음.

---

## 2. 수정 및 개선 방안 (Modification Plan)

현재 스크립트를 안정적으로 운영하기 위해 다음과 같은 수정을 제안합니다.

### 2.1 [긴급] API Key 및 권한 확인
- **Action**: Kakao Developers 콘솔 접속 -> 내 애플리케이션 -> 앱 설정 -> **플랫폼** 및 **Quota** 확인.
- **Check**: Local API가 활성화되어 있는지, 사용량이 초과되지 않았는지 확인.

### 2.2 [코드 수정] Circuit Breaker (차단기) 도입
현재 스크립트는 에러 발생 시에도 멈추지 않고 1,000건 이상을 계속 시도하여 불필요한 API 호출과 로그 낭비를 유발합니다.
- **Feat**: 연속적인 인증 에러(401, 403) 발생 시 스크립트를 즉시 중단하도록 수정.
- **Logic**: 연속 5회 이상 4XX 에러 발생 시 `sys.exit()` 처리.

### 2.3 [코드 수정] 로깅 인코딩 개선
Windows 환경에서 로그 파일과 콘솔 출력의 인코딩 불일치로 인한 깨짐 현상 해결.
- **Feat**: `StreamHandler` 설정 시 `sys.stdout`의 인코딩을 명시적으로 처리하거나, 로그 메시지 포맷팅 시 안전한 디코딩 적용.

### 2.4 [코드 수정] 기존 결과 보존 (Resume 기능)
이미 지오코딩된 파일이 입력으로 들어올 경우, 기존 `lat/lon` 값이 있는 행은 스킵(Skip)하도록 로직 개선.
- **Feat**: `lat`, `lon` 컬럼이 있고 값이 존재하면 API 호출 생략.

---

## 3. 결론
가장 시급한 문제는 **API Key 권한(403)** 해결입니다. 키가 정상화되기 전까지는 코드 수정만으로는 실행이 불가능합니다. 키 확인 후, 2.2항의 Circuit Breaker 기능을 추가하여 스크립트를 보완하는 것을 권장합니다.
